name: Functional tests

on:
  push:
    branches:
      - develop
  pull_request:
    branches:
      - develop

permissions:
  contents: read

jobs:
  functional:
    runs-on: [self-hosted, vm, debian-12]
    timeout-minutes: 120

    # NOTE(mikal): git repos are checked out to /srv/github/_work/{repo}/{repo}
    # which is available as GITHUB_WORKSPACE. You can find other environment
    # variables at https://docs.github.com/en/actions/learn-github-actions/environment-variables

    steps:
      - name: Remove previous unfinished runs
        uses: n1hility/cancel-previous-runs@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Get rid of sudo error messages
        run: |
          hostname=$(cat /etc/hostname)
          sudo chmod ugo+rw /etc/hosts
          echo "127.0.1.1 $hostname" >> /etc/hosts

      - name: Install minimum dependencies
        run: |
          sudo apt-get update
          sudo apt-get dist-upgrade -y
          sudo apt-get install -y python3 python3-dev python3-pip python3-wheel apparmor docker.io runc
          sudo systemctl restart apparmor

      - name: Log docker setup
        run: |
          sudo chown debian.debian /var/run/docker.sock

          echo "/var/run/docker.sock:"
          sudo ls -l /var/run/docker.sock

      - name: Checkout occystrap
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Build occystrap wheel and install it in a venv
        run: |
          python3 -mvenv ~/occystrap-venv
          ~/occystrap-venv/bin/pip3 install build
          ~/occystrap-venv/bin/python3 -m build
          ~/occystrap-venv/bin/pip3 install dist/occystrap*.whl

      - name: Run a local docker registry to talk to, and populate it with test data
        run: |
          docker run -d -p 5000:5000 --restart=always --name registry mirror.gcr.io/registry:2
          cd deploy/occystrap_ci/testdata
          start_dir=$(pwd)

          for img in deletion_layers; do
            cd $img
            docker build -t localhost:5000/occystrap_$img:latest .
            docker push localhost:5000/occystrap_$img:latest
            cd ${start_dir}
          done

          # Pull standard images from mirror.gcr.io and push to local registry
          # for use in tests (avoids proxy issues with direct registry access)
          for img in busybox hello-world ubuntu; do
            docker pull mirror.gcr.io/library/$img:latest
            docker tag mirror.gcr.io/library/$img:latest localhost:5000/library/$img:latest
            docker push localhost:5000/library/$img:latest
          done

      - name: Run functional tests
        run: |
          cd deploy
          . ~/occystrap-venv/bin/activate
          pip3 install -r requirements.txt
          pip3 install -r test-requirements.txt

          # This needs to run as root because some of the tests require
          # escalated permissions.
          sudo /home/debian/occystrap-venv/bin/stestr run --concurrency=5

  automated_reviewer:
    name: "Automated reviewer"
    permissions:
      contents: read
      pull-requests: write
    runs-on: [self-hosted, claude-code]
    needs: [functional]
    if: github.event_name == 'pull_request'
    concurrency:
      group: ${{ github.workflow }}-${{ github.ref }}-reviewer
      cancel-in-progress: true

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Run automated reviewer
        uses: shakenfist/actions/review-pr-with-claude@main
        with:
          pr-number: ${{ github.event.pull_request.number }}
