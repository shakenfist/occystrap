name: PR Retest

# Triggers a re-run of functional tests when an authorized user comments
# "@shakenfist-bot please retest"
#
# This is useful after bot commits (which don't trigger CI) or when you
# want to re-run checks without pushing a new commit.

on:
  issue_comment:
    types: [created]

permissions:
  contents: read
  issues: write
  pull-requests: write
  actions: write

jobs:
  trigger-retest:
    name: "Trigger retest"
    # Only run on PR comments (not issue comments)
    if: |
      github.event.issue.pull_request &&
      contains(github.event.comment.body, '@shakenfist-bot please retest')
    runs-on: [self-hosted, static]

    steps:
      - name: Handle trigger
        id: trigger
        uses: shakenfist/actions/pr-bot-trigger@main
        with:
          trigger-phrase: 'please retest'
          reaction: 'rocket'

      - name: Trigger functional tests
        if: steps.trigger.outputs.authorized == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_REF: ${{ steps.trigger.outputs.pr-ref }}
        run: |
          echo "Triggering functional tests on branch: ${PR_REF}"

          gh workflow run functional-tests.yml \
            --repo "${{ github.repository }}" \
            --ref "${PR_REF}"

          echo "Functional tests triggered successfully"

      - name: Post confirmation
        if: steps.trigger.outputs.authorized == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_REF: ${{ steps.trigger.outputs.pr-ref }}
        run: |
          gh pr comment "${{ github.event.issue.number }}" \
            --repo "${{ github.repository }}" \
            --body "Triggered functional tests on branch \`${PR_REF}\`.

          [View workflow runs](https://github.com/${{ github.repository }}/actions/workflows/functional-tests.yml)"
