autocancelConsecutiveBuilds()

pipeline {
  agent any
  options {
    timeout(time: 2, unit: 'HOURS')
  }

  stages {
    stage('Build infra') {
      steps {
        sh '''  mkdir $WORKSPACE/$BUILD_TAG
                ls -A | grep -v $BUILD_TAG | xargs -t -I '__' mv __ $WORKSPACE/$BUILD_TAG/

                . /home/jenkins/sf-ci
                cd $WORKSPACE/$BUILD_TAG/
                ansible-playbook -i /home/jenkins/hosts \
                    --extra-vars "identifier=$BUILD_TAG source_path=$WORKSPACE/$BUILD_TAG/ \
                    base_image=label:sfci-debian-11 \
                    base_image_user=debian" \
                    deploy/ansible/ci.yml
           '''
      }
    }
    stage('Run CI tests on primary') {
      steps {
        script {
          timeout(time: 60, unit: 'MINUTES', activity: true) {
            sh '''  . $WORKSPACE/$BUILD_TAG/ci-environment.sh
                    ssh -i /home/jenkins/id_ci -o StrictHostKeyChecking=no \
                        -o UserKnownHostsFile=/dev/null \
                        debian@$primary "cd /srv/occystrap/deploy/; OCCYSTRAP_CI_CONCURRENCY=6 tox -epy3"
              '''
          }
        }
      }
    }
  }
}